<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat - Metanit.com</title>
    <style>
        td {
            width: 30px;
            height: 30px;
        }

        button {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<header id="game_status">
    Waiting other
</header>

<div>
    <h3>Place ship type</h3>
    <label>
        <input type="checkbox" name="check" onclick="onlyOne(this)" id="1" checked />
        Single
    </label>

    <label>
        <input type="checkbox" name="check" onclick="onlyOne(this)" id="2" />
        Middle
    </label>

    <label>
        <input type="checkbox" name="check" onclick="onlyOne(this)" id="3"/>
        Big
    </label>

    <label>
        <input type="checkbox" name="check" onclick="onlyOne(this)" id="4" />
        Large
    </label>
</div>

<div>
    <input type="checkbox" id="check_vertical" checked />
    <label for="check_vertical">Vertical</label>
</div>

<table id="self_holder"></table>

<table id="opponent_holder"></table>

<script src="lib/signalr/signalr.js"></script>
<script>
    
    var selectedShipType = parseInt(1);
    
    function onlyOne(checkbox) {
        var checkboxes = document.getElementsByName(checkbox.name)
        
        selectedShipType = parseInt(checkbox.id);
        
        checkboxes.forEach((item) => {
            if (item !== checkbox) item.checked = false
        })
    } 
    
    const hubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/hub")
        .build();
    
    function generate(holder, clickFunction){
        var table = document.getElementById(holder); 
        var rowButtonNumber = 10;
        var buttonNumber = 100;
        
        for (var i = 0; i < buttonNumber; i++) {
            var tr = document.createElement("tr");
            table.appendChild(tr);
            
            for (var j = 0; j < rowButtonNumber; j++, i++) {
                var td = document.createElement("td");
                var btn = document.createElement("button");
                btn.innerHTML = "💧";
                btn.id = i;
                btn.onclick = clickFunction;
                if (i >= buttonNumber) {
                    break;
                } else {
                    td.appendChild(btn);
                    tr.appendChild(td);
                }
            }
            i--;
        }
    }
    
    function update(holder, array) {
        var tableElement = document.querySelector('#' + holder);
        var i = 0;
        
        array.forEach(cell => {
            var view = "";

            switch (cell) {
                case 0:
                    view = "💧";
                    break;

                case 1:
                    view = "⚓";
                    break;

                case 2:
                    view = "💥";
                    break;

                case 3:
                    view = "🔥";
                    break;

                default:
                    break;
            }

            tableElement.querySelector("[id='" + i + "']")
                .textContent = view

            i = ++i;
        });
    }
    // TODO: добавить горизональное расположение
    
    hubConnection.on("LoadGame", () => {
        let statusElement = document.getElementById("game_status");
        statusElement.textContent = "Gaming";
        
        alert("GameStarted, select ship place");
        
        generate("self_holder", function ()
        {
            hubConnection.invoke("Place", {
                CellIndex: parseInt(this.id),
                Type: selectedShipType,
                IsVertical: document
                    .querySelector("#check_vertical")
                    .checked
            });
        });
        
        generate("opponent_holder", function () {
            hubConnection.invoke("Shoot", {
                CellIndex: parseInt(this.id),
            });
        });
    });
    
    hubConnection.on("UpdateSelfField", (view) => {
        update("self_holder", view['self']);
        update("opponent_holder", view['opponent']);
    });

    hubConnection.start();
</script>
</body>